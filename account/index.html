<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Explorer Account</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700&family=Chakra+Petch:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="../js/firebase-project-config.js"></script>
  <style>
    :root {
      --bg: #081425;
      --panel: rgba(12, 31, 55, 0.82);
      --line: rgba(174, 202, 226, 0.3);
      --ink: #eaf4ff;
      --muted: #afc4d8;
      --accent: #5ac8ff;
      --gold: #ffc857;
      --ok: #59d39c;
      --warn: #ff8b8b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Barlow', sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 16% 16%, rgba(90, 200, 255, 0.18), transparent 44%),
        radial-gradient(circle at 82% 12%, rgba(255, 200, 87, 0.14), transparent 36%),
        linear-gradient(170deg, #12365a, var(--bg));
      min-height: 100vh;
    }

    .wrap {
      width: min(980px, 92vw);
      margin: 0 auto;
      padding: 26px 0 40px;
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .top a {
      color: var(--ink);
      text-decoration: none;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 600;
    }

    h1 {
      margin: 0;
      font-size: clamp(30px, 5vw, 44px);
      font-family: 'Chakra Petch', sans-serif;
      letter-spacing: 0.02em;
    }

    .sub {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 16px;
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: var(--panel);
      backdrop-filter: blur(6px);
      padding: 18px;
      margin-top: 16px;
      box-shadow: 0 18px 38px rgba(4, 10, 20, 0.35);
    }

    .status {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }

    .status-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: rgba(5, 17, 32, 0.45);
    }

    .label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .value {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 24px;
      margin: 0;
    }

    .hint {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    button {
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 11px 16px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.16s ease, filter 0.16s ease;
    }

    button:hover { transform: translateY(-1px); filter: brightness(1.05); }
    button:disabled { opacity: 0.56; cursor: not-allowed; transform: none; }

    .btn-primary { background: var(--accent); color: #032137; }
    .btn-supporter { background: #5fc8ff; color: #06253e; }
    .btn-pro { background: var(--gold); color: #392700; }
    .btn-ghost { background: rgba(8, 22, 40, 0.58); border-color: var(--line); color: var(--ink); }

    .plans {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 14px;
    }

    .plan {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: rgba(5, 17, 32, 0.45);
    }

    .plan h2 {
      margin: 0;
      font-size: 20px;
      font-family: 'Chakra Petch', sans-serif;
    }

    .plan p {
      margin: 6px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .plan ul {
      margin: 6px 0 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 14px;
    }

    .links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      font-size: 14px;
    }

    .links a { color: #d6ebff; }

    #authPrompt { display: none; }

    #statusLine {
      min-height: 20px;
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
    }

    .ok { color: var(--ok) !important; }
    .warn { color: var(--warn) !important; }

    @media (max-width: 780px) {
      .status { grid-template-columns: 1fr; }
      .plans { grid-template-columns: 1fr; }
      .actions button { width: 100%; }
      .top { flex-wrap: wrap; }
      .top a { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Account</h1>
      <a href="../app/">Back to App</a>
    </div>
    <p class="sub">Manage plan status, upgrades, and billing portal access.</p>

    <section class="panel" id="authPrompt">
      <p class="hint">Sign in to view and manage your trial or subscription.</p>
      <div class="actions">
        <button id="signInBtn" class="btn-primary" type="button">Sign In</button>
      </div>
    </section>

    <section class="panel" id="accountPanel">
      <div class="status">
        <article class="status-item">
          <span class="label">Current Plan</span>
          <p id="planLabel" class="value">Free</p>
          <p id="planDetail" class="hint">Core exploration active.</p>
        </article>
        <article class="status-item">
          <span class="label">Trial</span>
          <p id="trialLabel" class="value">Not active</p>
          <p id="trialDetail" class="hint">No trial is currently running.</p>
        </article>
      </div>

      <div class="actions">
        <button id="upgradeSupporterBtn" class="btn-supporter" type="button">Upgrade to Supporter ($1/mo)</button>
        <button id="upgradeProBtn" class="btn-pro" type="button">Upgrade to Pro ($5/mo)</button>
        <button id="manageBillingBtn" class="btn-ghost" type="button">Manage Billing</button>
        <button id="signOutBtn" class="btn-ghost" type="button">Sign Out</button>
      </div>

      <p id="statusLine"></p>

      <div class="plans">
        <article class="plan">
          <h2>Supporter</h2>
          <p>$1/month</p>
          <ul>
            <li>Full world access</li>
            <li>Cloud sync enabled</li>
            <li>Supports future updates</li>
          </ul>
        </article>
        <article class="plan">
          <h2>Pro</h2>
          <p>$5/month</p>
          <ul>
            <li>Everything in Supporter</li>
            <li>Early playable demos</li>
            <li>Priority contact and feature consideration</li>
          </ul>
        </article>
      </div>

      <div class="links">
        <a href="../legal/privacy">Privacy</a>
        <a href="../legal/terms">Terms</a>
        <a href="mailto:hello@worldexplorer.app">Contact</a>
        <a href="https://github.com/RRG314/WorldExplorer" target="_blank" rel="noreferrer">GitHub</a>
      </div>
    </section>
  </div>

  <script type="module">
    import { hasFirebaseConfig } from '../js/firebase-init.js';
    import { ensureSignedIn, observeAuth, signOutUser } from '../js/auth-ui.js';
    import { ensureEntitlements, formatRemainingTrial, subscribeEntitlements } from '../js/entitlements.js';
    import { redirectToCheckout, redirectToPortal } from '../js/billing.js';

    const authPrompt = document.getElementById('authPrompt');
    const accountPanel = document.getElementById('accountPanel');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const upgradeSupporterBtn = document.getElementById('upgradeSupporterBtn');
    const upgradeProBtn = document.getElementById('upgradeProBtn');
    const manageBillingBtn = document.getElementById('manageBillingBtn');
    const statusLine = document.getElementById('statusLine');
    const planLabel = document.getElementById('planLabel');
    const planDetail = document.getElementById('planDetail');
    const trialLabel = document.getElementById('trialLabel');
    const trialDetail = document.getElementById('trialDetail');

    let unsubscribeEntitlements = null;
    let signedInUser = null;

    function setStatus(message, type = 'neutral') {
      statusLine.textContent = message || '';
      statusLine.classList.remove('ok', 'warn');
      if (type === 'ok') statusLine.classList.add('ok');
      if (type === 'warn') statusLine.classList.add('warn');
    }

    function setBusy(busy) {
      [signInBtn, signOutBtn, upgradeSupporterBtn, upgradeProBtn, manageBillingBtn].forEach((btn) => {
        if (!btn) return;
        btn.disabled = busy;
      });
    }

    function renderSignedOutState() {
      authPrompt.style.display = hasFirebaseConfig() ? 'block' : 'none';
      accountPanel.style.display = hasFirebaseConfig() ? 'none' : 'block';

      if (!hasFirebaseConfig()) {
        planLabel.textContent = 'Free';
        planDetail.textContent = 'Firebase config is missing. Add config to enable trial and billing.';
        trialLabel.textContent = 'Unavailable';
        trialDetail.textContent = 'Set WORLD_EXPLORER_FIREBASE to enable account features.';
        setStatus('Missing Firebase config (WORLD_EXPLORER_FIREBASE).', 'warn');
      } else {
        setStatus('Sign in to manage your account.', 'neutral');
      }
    }

    function applyPlanUi(state) {
      planLabel.textContent = state.planLabel;

      if (state.plan === 'pro') {
        planDetail.textContent = 'Pro perks unlocked, including early demos and priority communication.';
      } else if (state.plan === 'supporter') {
        planDetail.textContent = 'Supporter active with full access and cloud sync.';
      } else if (state.plan === 'trial') {
        planDetail.textContent = 'Trial active with full access (Pro-only perks disabled).';
      } else {
        planDetail.textContent = 'Free plan: core exploration with local-only saves.';
      }

      if (state.plan === 'trial') {
        const remaining = formatRemainingTrial(state);
        trialLabel.textContent = remaining === 'expired' ? 'Expired' : 'Active';
        trialDetail.textContent = remaining && remaining !== 'expired' ? `${remaining}.` : 'Trial expired. Upgrade to keep premium perks.';
      } else {
        trialLabel.textContent = 'Not active';
        trialDetail.textContent = 'No trial currently running.';
      }

      upgradeSupporterBtn.disabled = state.plan === 'supporter' || state.plan === 'pro';
      upgradeProBtn.disabled = state.plan === 'pro';
      manageBillingBtn.disabled = !(state.stripeCustomerId || state.plan === 'supporter' || state.plan === 'pro');
    }

    async function handleSignedIn(user) {
      signedInUser = user;
      authPrompt.style.display = 'none';
      accountPanel.style.display = 'block';

      if (unsubscribeEntitlements) unsubscribeEntitlements();

      const state = await ensureEntitlements(user);
      applyPlanUi(state);
      setStatus(`Signed in as ${user.email || user.uid}.`, 'ok');

      unsubscribeEntitlements = subscribeEntitlements(user, (nextState) => {
        applyPlanUi(nextState);
      });
    }

    signInBtn.addEventListener('click', async () => {
      setBusy(true);
      setStatus('Signing in...');
      try {
        const user = await ensureSignedIn();
        if (user) {
          await handleSignedIn(user);
        } else {
          setStatus('Continue sign-in in the popup/redirect flow.');
        }
      } catch (err) {
        console.error('[account] sign-in failed:', err);
        setStatus(err && err.message ? err.message : 'Sign-in failed.', 'warn');
      } finally {
        setBusy(false);
      }
    });

    signOutBtn.addEventListener('click', async () => {
      setBusy(true);
      try {
        if (unsubscribeEntitlements) {
          unsubscribeEntitlements();
          unsubscribeEntitlements = null;
        }
        await signOutUser();
        signedInUser = null;
        renderSignedOutState();
        setStatus('Signed out.');
      } catch (err) {
        console.error('[account] sign-out failed:', err);
        setStatus('Could not sign out.', 'warn');
      } finally {
        setBusy(false);
      }
    });

    upgradeSupporterBtn.addEventListener('click', async () => {
      if (!signedInUser) return;
      setBusy(true);
      setStatus('Opening Stripe Checkout for Supporter...');
      try {
        await redirectToCheckout('supporter');
      } catch (err) {
        console.error('[account] Supporter checkout failed:', err);
        setStatus(err && err.message ? err.message : 'Checkout failed.', 'warn');
        setBusy(false);
      }
    });

    upgradeProBtn.addEventListener('click', async () => {
      if (!signedInUser) return;
      setBusy(true);
      setStatus('Opening Stripe Checkout for Pro...');
      try {
        await redirectToCheckout('pro');
      } catch (err) {
        console.error('[account] Pro checkout failed:', err);
        setStatus(err && err.message ? err.message : 'Checkout failed.', 'warn');
        setBusy(false);
      }
    });

    manageBillingBtn.addEventListener('click', async () => {
      if (!signedInUser) return;
      setBusy(true);
      setStatus('Opening billing portal...');
      try {
        await redirectToPortal();
      } catch (err) {
        console.error('[account] Portal failed:', err);
        setStatus(err && err.message ? err.message : 'Could not open billing portal.', 'warn');
        setBusy(false);
      }
    });

    const checkoutStatus = new URLSearchParams(window.location.search).get('checkout');
    if (checkoutStatus === 'success') {
      setStatus('Checkout complete. Plan updates can take a few seconds after webhook processing.', 'ok');
    } else if (checkoutStatus === 'cancel') {
      setStatus('Checkout canceled. No changes were made.', 'warn');
    }

    if (!hasFirebaseConfig()) {
      renderSignedOutState();
    } else {
      observeAuth(async (user) => {
        if (!user) {
          renderSignedOutState();
          signedInUser = null;
          if (unsubscribeEntitlements) {
            unsubscribeEntitlements();
            unsubscribeEntitlements = null;
          }
          return;
        }

        try {
          await handleSignedIn(user);
        } catch (err) {
          console.error('[account] failed to load state:', err);
          setStatus('Could not load account status.', 'warn');
        }
      });
    }
  </script>
</body>
</html>
